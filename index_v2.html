<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wedding Blog AI v2</title>
  <meta name="description" content="Blogpost anfordern. Titel per KI optimieren. Ergebnis kommt per E Mail." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üíç</text></svg>">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,#1a1a2e 0%,#16213e 25%,#0f3460 50%,#533483 75%,#7209b7 100%);
      min-height:100vh;
      padding:20px;
      color:#fff;
      overflow-x:hidden;
      font-size:14px;
    }

    .container{
      max-width:900px;
      margin:0 auto;
      background:rgba(26,26,46,0.85);
      backdrop-filter:blur(15px);
      padding:24px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.1);
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      overflow-y:auto;
    }

    .logo{
      font-size:20px;
      font-weight:700;
      color:rgba(255,255,255,0.95);
      margin-bottom:24px;
      text-align:center;
      padding-bottom:16px;
      border-bottom:1px solid rgba(255,255,255,0.15);
    }

    .api-notice{
      background:rgba(255,193,7,0.1);
      border:1px solid rgba(255,193,7,0.3);
      border-radius:12px;
      padding:16px;
      margin-bottom:24px;
      font-size:13px;
      color:rgba(255,255,255,0.9);
    }
    .api-notice strong{ color:#ffc107; }

    .input-group{ margin-bottom:20px; position:relative; }
    .input-group label{
      display:block;
      font-weight:500;
      color:rgba(255,255,255,0.9);
      margin-bottom:8px;
      font-size:14px;
    }

    .input-group input,
    .input-group textarea,
    .input-group select{
      width:100%;
      padding:14px 16px;
      border:1px solid rgba(255,255,255,0.2);
      border-radius:12px;
      font-size:14px;
      font-family:inherit;
      transition:all 0.2s ease;
      background:rgba(0,0,0,0.3);
      backdrop-filter:blur(10px);
      color:rgba(255,255,255,0.95);
    }

    .input-group input:focus,
    .input-group textarea:focus,
    .input-group select:focus{
      outline:none;
      border-color:#7209b7;
      box-shadow:0 0 0 3px rgba(114,9,183,0.3);
      background:rgba(0,0,0,0.5);
    }

    .input-group textarea{ resize:vertical; min-height:90px; }

    .input-with-magic{
      display:flex;
      gap:12px;
      align-items:stretch;
    }
    .input-with-magic input{ flex:1; }

    .magic-btn{
      width:50px;
      height:50px;
      background:linear-gradient(135deg,#ff6b35,#f7931e);
      border:none;
      border-radius:12px;
      color:#fff;
      font-size:18px;
      cursor:pointer;
      transition:all 0.2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 4px 12px rgba(255,107,53,0.3);
    }
    .magic-btn:hover{
      transform:translateY(-2px) scale(1.05);
      box-shadow:0 8px 20px rgba(255,107,53,0.4);
      background:linear-gradient(135deg,#ff8c5a,#ffb347);
    }
    .magic-btn:active{ transform:scale(0.95); }
    .magic-btn.loading{ animation:magicSpin 1s linear infinite; }
    @keyframes magicSpin{ 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

    .tag-input-container{ position:relative; }
    .keywords-display{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:12px;
      min-height:24px;
    }
    .keyword-pill{
      color:#fff;
      padding:6px 12px;
      border-radius:16px;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
      position:relative;
    }
    .keyword-pill.primary{
      background:linear-gradient(135deg,#ff6b35,#f7931e);
      border:2px solid rgba(255,255,255,0.3);
      font-weight:600;
      padding:7px 14px;
    }
    .keyword-pill.primary::before{ content:"üëë"; font-size:10px; margin-right:4px; }
    .keyword-pill.secondary{ background:linear-gradient(135deg,#7209b7,#533483); }
    .keyword-remove{ cursor:pointer; font-weight:bold; font-size:16px; opacity:0.8; transition:opacity 0.2s; }
    .keyword-remove:hover{ opacity:1; }

    .dropdown{
      position:absolute;
      top:100%;
      left:0;
      right:0;
      background:rgba(26,26,46,0.95);
      backdrop-filter:blur(15px);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:12px;
      max-height:200px;
      overflow-y:auto;
      z-index:1000;
      display:none;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
    }
    .dropdown-item{
      padding:12px 16px;
      cursor:pointer;
      transition:background 0.2s;
      font-size:13px;
      color:rgba(255,255,255,0.9);
    }
    .dropdown-item:hover{ background:rgba(114,9,183,0.3); }
    .dropdown-item.create-new{ color:#20c997; font-weight:500; }

    .keyword-limit-info{
      font-size:11px;
      color:rgba(255,255,255,0.6);
      margin-top:4px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .keyword-counter{
      background:rgba(255,255,255,0.1);
      padding:2px 8px;
      border-radius:10px;
      font-weight:500;
    }
    .keyword-counter.full{ background:rgba(255,107,53,0.3); color:#ff6b35; }

    .primary-btn{
      width:100%;
      padding:16px;
      background:linear-gradient(135deg,#28a745,#20c997);
      color:#fff;
      border:none;
      border-radius:12px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s ease;
      box-shadow:0 6px 16px rgba(40,167,69,0.3);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin-bottom:10px;
    }
    .primary-btn:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(40,167,69,0.4);
      background:linear-gradient(135deg,#34ce57,#17a2b8);
    }
    .primary-btn:disabled{ opacity:0.5; cursor:not-allowed; transform:none; }

    .hint-line{
      font-size:12px;
      color:rgba(255,255,255,0.75);
      margin-top:6px;
      line-height:1.35;
    }

    .status-message{
      background:rgba(26,26,46,0.8);
      backdrop-filter:blur(15px);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:12px;
      padding:16px;
      margin:16px 0;
      box-shadow:0 4px 16px rgba(0,0,0,0.2);
      color:rgba(255,255,255,0.95);
      font-size:14px;
      line-height:1.5;
      animation:slideIn 0.3s ease;
    }
    @keyframes slideIn{
      from{ opacity:0; transform:translateY(-15px); }
      to{ opacity:1; transform:translateY(0); }
    }

    .typing{ display:none; text-align:center; margin:20px 0; }
    .typing-content{
      background:rgba(26,26,46,0.8);
      backdrop-filter:blur(15px);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:12px;
      padding:16px;
      display:inline-block;
    }
    .typing-dots{ display:inline-flex; gap:6px; }
    .typing-dots span{
      width:6px; height:6px;
      background:rgba(255,255,255,0.8);
      border-radius:50%;
      animation:typing 1.4s infinite ease-in-out;
    }
    .typing-dots span:nth-child(2){ animation-delay:0.2s; }
    .typing-dots span:nth-child(3){ animation-delay:0.4s; }
    @keyframes typing{
      0%,80%,100%{ transform:scale(0.8); opacity:0.3; }
      40%{ transform:scale(1); opacity:1; }
    }

    @media (max-width:768px){
      body{ padding:10px; font-size:13px; }
      .container{ padding:16px; margin:10px; }
      .input-with-magic{ flex-direction:column; }
      .magic-btn{ width:100%; height:50px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="logo">üíç Wedding Blog AI v2</div>

    <div class="api-notice">
      <strong>Hinweis:</strong>
      Du optimierst nur den Titel per KI. Den kompletten Blogpost erstellt unser System und schickt dir das Ergebnis per E Mail.
    </div>

    <div class="input-group">
      <label>Titel des Blogbeitrags (H1)</label>
      <div class="input-with-magic">
        <input type="text" id="blogTitle" placeholder="z.B. Hochzeitsbudget planen: Kosten und Tipps" />
        <button class="magic-btn" id="optimizeTitleBtn" onclick="optimizeTitle()" title="Titel SEO optimieren">ü™Ñ</button>
      </div>
      <div class="hint-line">
        Dieser Button nutzt KI und zieht Credits ab.
      </div>
    </div>

    <div class="input-group">
      <label>Keywords (SEO), max. 3, erstes Keyword ist das Hauptkeyword</label>
      <div class="tag-input-container">
        <div class="keywords-display" id="keywordsDisplay"></div>
        <input type="text" id="mainKeyword" placeholder="z.B. Hochzeitsbudget, Kosten Hochzeit, Budgetplan" autocomplete="off" />
        <div class="dropdown" id="keywordDropdown"></div>
      </div>
      <div class="keyword-limit-info">
        <span>Enter dr√ºckt das Keyword rein</span>
        <span class="keyword-counter" id="keywordCounter">0/3</span>
      </div>
    </div>

    <div class="input-group">
     <label>Deine Dienstleistung (f√ºr passende Backlinks)</label>
     <select id="service" required>
       <option value="" selected disabled>Bitte w√§hlen</option>
       <option value="Hochzeitsplaner">Hochzeitsplaner</option>
       <option value="Deko">Deko</option>
       <option value="Freie Trauung">Freie Trauung</option>
       <option value="Musik">Musik</option>
       <option value="Foto / Video">Foto / Video</option>
       <option value="DJ">DJ</option>
       <option value="Brautmode">Brautmode</option>
       <option value="Herrenausstatter">Herrenausstatter</option>
       <option value="Location">Location</option>
     </select>
   </div>


    <div class="input-group">
      <label>Gew√ºnschte Wortanzahl</label>
      <select id="wordCount">
        <option value="800">800 bis 1000 W√∂rter</option>
        <option value="1500" selected>1500 bis 2000 W√∂rter</option>
        <option value="2500">2500 bis 3000 W√∂rter</option>
      </select>
    </div>

    <div class="input-group">
      <label>Ton und Stil</label>
      <select id="toneStyle">
        <option value="freundlich-beratend" selected>Freundlich und beratend</option>
        <option value="professionell-sachlich">Professionell und sachlich</option>
        <option value="emotional-inspirierend">Emotional und inspirierend</option>
        <option value="praktisch-hilfsbereit">Praktisch und hilfsbereit</option>
        <option value="luxurioes-exklusiv">Luxuri√∂s und exklusiv</option>
      </select>
    </div>

    <div class="input-group">
      <label>Zus√§tzliche Hinweise (optional)</label>
      <textarea id="notes" placeholder="z.B. Bitte eine FAQ Frage einbauen. Bitte ein Praxisbeispiel. Bitte keine Floskeln."></textarea>
      <div class="hint-line">
        Diese Hinweise werden als Content Hinweise mitgegeben.
      </div>
    </div>

    <button class="primary-btn" id="requestPostBtn" onclick="requestPostByEmail()">
      üì© Blogpost anfordern, Ergebnis per E Mail
    </button>
    <div class="hint-line">
      Nach dem Absenden bekommst du eine Best√§tigung. Das Ergebnis kommt sp√§ter per E Mail.
    </div>

    <div id="statusMessages"></div>

    <div class="typing" id="typing">
      <div class="typing-content">
        <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // v2 Settings
    // =========================
    const WRITER_REQUEST_WEBHOOK = 'https://n8n.maikranz-business.com/webhook/90698a91-081f-45ba-8901-c1c32dfa7262';

    // =========================
    // Learningsuite Context (aus Query)
    // Wrapper setzt: ?user_id=...&tool_id=...&email=...&first_name=...
    // =========================
    const QS = new URLSearchParams(location.search);
    const TOOL_ID = Number(QS.get('tool_id') || '0');
    const USER_ID = String(QS.get('user_id') || '').trim();
    const USER_EMAIL = String(QS.get('email') || '').trim();
    const FIRST_NAME = String(QS.get('first_name') || '').trim();

    // =========================
    // UI Helpers
    // =========================
    function showStatusMessage(html) {
      const statusContainer = document.getElementById('statusMessages');
      if (!statusContainer) return;
      const message = document.createElement('div');
      message.className = 'status-message';
      message.innerHTML = html;
      statusContainer.appendChild(message);
      statusContainer.scrollTop = statusContainer.scrollHeight;

      if (html.includes('‚úÖ')) {
        setTimeout(() => { if (message.parentNode) message.remove(); }, 12000);
      }
    }

    function clearStatusMessages() {
      const statusContainer = document.getElementById('statusMessages');
      if (statusContainer) statusContainer.innerHTML = '';
    }

    function showTyping() {
      const typing = document.getElementById('typing');
      if (typing) typing.style.display = 'block';
    }

    function hideTyping() {
      const typing = document.getElementById('typing');
      if (typing) typing.style.display = 'none';
    }

    // Toast im Tool
    function showToast(msg) {
      let box = document.getElementById('mkz-toast');
      if (!box) {
        box = document.createElement('div');
        box.id = 'mkz-toast';
        box.style.cssText = 'position:fixed;right:16px;bottom:16px;z-index:99999;display:flex;flex-direction:column;gap:8px';
        document.body.appendChild(box);
      }
      const n = document.createElement('div');
      n.style.cssText = 'padding:10px 14px;border-radius:10px;font:14px system-ui;color:#fff;background:#b91c1c;box-shadow:0 4px 16px rgba(0,0,0,.25)';
      n.textContent = msg;
      box.appendChild(n);
      setTimeout(() => n.remove(), 4200);
    }

    // =========================
    // Credits Gate (Learningsuite Bridge)
    // =========================
    function preflight(kind = 'tool') {
      return new Promise(resolve => {
        const onMsg = (ev) => {
          const d = ev.data || {};
          if (d.mkz === 'allow_generate') {
            window.removeEventListener('message', onMsg);
            resolve(true);
          }
          if (d.mkz === 'deny_generate') {
            window.removeEventListener('message', onMsg);
            showToast(d.reason === 'limit'
              ? `Credit Limit erreicht. Noch ${d.days_left} Tage bis Reset.`
              : 'Aktion abgebrochen.'
            );
            resolve(false);
          }
        };
        window.addEventListener('message', onMsg);
        window.parent.postMessage({ mkz: 'request_generate', tool_id: TOOL_ID, kind }, '*');
        setTimeout(() => { window.removeEventListener('message', onMsg); resolve(false); }, 5000);
      });
    }

    let lastConsumeAt = 0;
    function sendConsume(action, input = {}, output = {}, kind = 'tool') {
      const now = Date.now();
      if (now - lastConsumeAt < 1200) return;
      lastConsumeAt = now;
      window.parent.postMessage({ mkz: 'consume', tool_id: TOOL_ID, kind, payload: { action, input, output } }, '*');
    }

    // Height Reporting
    function reportHeight() {
      const h = Math.max(
        document.documentElement.scrollHeight,
        document.body.scrollHeight,
        document.documentElement.offsetHeight,
        document.body.offsetHeight
      );
      window.parent?.postMessage({ mkz: 'content_height', tool_id: TOOL_ID, height: h }, '*');
    }
    window.addEventListener('message', ev => { if ((ev.data || {}).mkz === 'request_height') reportHeight(); });
    const ro = new ResizeObserver(() => reportHeight());
    ro.observe(document.documentElement);
    ro.observe(document.body);
    setInterval(reportHeight, 2000);
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';

    // =========================
    // Keyword Tag System
    // =========================
    const MAX_KEYWORDS = 3;
    let selectedKeywords = [];

    const predefinedKeywords = [
      'Hochzeit','Hochzeitsplanung','Hochzeitslocation','Freie Trauung','Hochzeitsbudget','Kosten Hochzeit',
      'Hochzeitsfotograf','Hochzeitsvideograf','Hochzeitsdeko','Trauredner','DJ Hochzeit','Hochzeitsband',
      'Hochzeitsgeschenk','Hochzeitsrede','Hochzeitseinladung','Hochzeitstorte','Brautkleid','Brautfrisur'
    ];

    function updateKeywordCounter() {
      const counter = document.getElementById('keywordCounter');
      if (!counter) return;
      counter.textContent = `${selectedKeywords.length}/${MAX_KEYWORDS}`;
      if (selectedKeywords.length >= MAX_KEYWORDS) counter.classList.add('full');
      else counter.classList.remove('full');
    }

    function renderKeywords() {
      const container = document.getElementById('keywordsDisplay');
      if (!container) return;
      container.innerHTML = '';

      selectedKeywords.forEach((keyword, index) => {
        const pill = document.createElement('div');
        pill.className = index === 0 ? 'keyword-pill primary' : 'keyword-pill secondary';
        pill.innerHTML = `
          <span>${escapeHtml(keyword)}</span>
          <span class="keyword-remove" data-k="${escapeHtml(keyword)}">√ó</span>
        `;
        pill.querySelector('.keyword-remove').addEventListener('click', () => removeKeyword(keyword));
        container.appendChild(pill);
      });
    }

    function addKeyword(keywordText) {
      const k = String(keywordText || '').trim();
      if (!k) return;

      if (selectedKeywords.length >= MAX_KEYWORDS) {
        showStatusMessage(`‚ùå Du hast schon ${MAX_KEYWORDS} Keywords gesetzt. Entferne zuerst eins.`);
        return;
      }
      if (selectedKeywords.includes(k)) return;

      selectedKeywords.push(k);
      renderKeywords();
      updateKeywordCounter();

      const input = document.getElementById('mainKeyword');
      if (input) input.value = '';
      hideKeywordDropdown();
    }

    function removeKeyword(keywordText) {
      selectedKeywords = selectedKeywords.filter(k => k !== keywordText);
      renderKeywords();
      updateKeywordCounter();
    }

    function hideKeywordDropdown() {
      const dropdown = document.getElementById('keywordDropdown');
      if (dropdown) dropdown.style.display = 'none';
    }

    function showKeywordDropdown(searchTerm) {
      if (selectedKeywords.length >= MAX_KEYWORDS) { hideKeywordDropdown(); return; }

      const dropdown = document.getElementById('keywordDropdown');
      if (!dropdown) return;

      const value = String(searchTerm || '').trim().toLowerCase();
      const matches = predefinedKeywords
        .filter(k => k.toLowerCase().includes(value) && !selectedKeywords.includes(k))
        .slice(0, 8);

      let html = '';
      matches.forEach(k => {
        html += `<div class="dropdown-item" data-k="${escapeHtml(k)}">${escapeHtml(k)}</div>`;
      });

      const raw = String(searchTerm || '').trim();
      if (raw && !matches.some(m => m.toLowerCase() === raw.toLowerCase()) && !selectedKeywords.includes(raw)) {
        html += `<div class="dropdown-item create-new" data-k="${escapeHtml(raw)}">+ "${escapeHtml(raw)}" hinzuf√ºgen</div>`;
      }

      if (!html) { hideKeywordDropdown(); return; }

      dropdown.innerHTML = html;
      dropdown.style.display = 'block';

      dropdown.querySelectorAll('.dropdown-item').forEach(el => {
        el.addEventListener('click', () => addKeyword(el.getAttribute('data-k')));
      });
    }

    function escapeHtml(s) {
      return String(s || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function initKeywordTagSystem() {
      const input = document.getElementById('mainKeyword');
      if (!input) return;

      input.addEventListener('input', (e) => {
        const v = e.target.value || '';
        if (String(v).trim().length > 0) showKeywordDropdown(v);
        else hideKeywordDropdown();
      });

      input.addEventListener('focus', () => {
        const v = input.value || '';
        if (String(v).trim().length > 0) showKeywordDropdown(v);
        else showKeywordDropdown('');
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addKeyword(input.value);
        }
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.tag-input-container')) hideKeywordDropdown();
      });
    }

    // =========================
    // AI Title Optimize (bleibt wie v1)
    // =========================
    async function callAI(prompt, type = 'general') {
      const r = await fetch('/api/claude', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, type })
      });
      if (!r.ok) {
        const err = await r.json().catch(() => ({}));
        throw new Error(err.error || `API Fehler (${r.status})`);
      }
      const data = await r.json();
      return data.content;
    }

    window.optimizeTitle = async function optimizeTitle() {
      if (!(await preflight('tool'))) return;

      const titleInput = document.getElementById('blogTitle');
      if (!titleInput) return;

      const originalTitle = String(titleInput.value || '').trim();
      if (!originalTitle) {
        showStatusMessage('‚ùå Bitte gib zuerst einen Titel ein.');
        return;
      }

      const btn = document.getElementById('optimizeTitleBtn');
      if (btn) { btn.classList.add('loading'); btn.disabled = true; }
      showTyping();

      try {
        const optimizedTitle = await callAI(
          `Optimiere diesen Hochzeitsblog Titel f√ºr SEO: "${originalTitle}"
Regeln:
- Maximal 60 Zeichen
- Du Form
- Hauptkeyword m√∂glichst weit vorne
Gib nur den optimierten Titel zur√ºck, ohne Anf√ºhrungszeichen.`,
          'title-optimization'
        );

        titleInput.value = String(optimizedTitle || '').trim();
        showStatusMessage(`‚úÖ <strong>Optimierter Titel:</strong><br>${escapeHtml(titleInput.value)}`);

        sendConsume('optimize_title',
          { original_title: originalTitle },
          { optimized_title: titleInput.value }
        );

      } catch (e) {
        showStatusMessage(`‚ùå <strong>Fehler:</strong> ${escapeHtml(e.message || String(e))}`);
      } finally {
        hideTyping();
        if (btn) { btn.classList.remove('loading'); btn.disabled = false; }
      }
    };

    // =========================
    // Request Full Blog Post by Email (Webhook)
    // =========================
    window.requestPostByEmail = async function requestPostByEmail() {
      if (!(await preflight('tool'))) return;

      const title = String(document.getElementById('blogTitle')?.value || '').trim();
      const service = String(document.getElementById('service')?.value || '').trim();
      const wordCount = Number(document.getElementById('wordCount')?.value || '1500');
      const tone = String(document.getElementById('toneStyle')?.value || 'freundlich-beratend').trim();
      const notes = String(document.getElementById('notes')?.value || '').trim();

      if (!title) {
        showStatusMessage('‚ùå Bitte gib einen Titel ein.');
        return;
      }
      if (!selectedKeywords.length) {
        showStatusMessage('‚ùå Bitte setze mindestens ein Keyword.');
        return;
      }
      if (!service) {
        showStatusMessage('‚ùå Bitte trage deine Dienstleistung ein, damit Backlinks passend gew√§hlt werden.');
        return;
      }
      if (!USER_EMAIL) {
        showStatusMessage('‚ùå Deine E Mail fehlt. Bitte √∂ffne das Tool √ºber die Learningsuite Card.');
        return;
      }

      const btn = document.getElementById('requestPostBtn');
      if (btn) { btn.disabled = true; btn.innerHTML = '‚è≥ Anfrage wird gesendet...'; }

      showTyping();
      clearStatusMessages();

      const payload = {
        schemaVersion: 1,
        source: 'learningsuite_wedding_blog_ai_v2',
        requestedAtIso: new Date().toISOString(),
        requester: {
          userId: USER_ID,
          email: USER_EMAIL,
          firstName: FIRST_NAME,
          toolId: TOOL_ID
        },
        input: {
          title,
          mainKeyword: selectedKeywords[0] || '',
          keywords: selectedKeywords,
          service,
          notes,
          wordCount,
          tone,
          language: 'de'
        }
      };

      try {
        const r = await fetch(WRITER_REQUEST_WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // Wenn n8n nicht als JSON antwortet, trotzdem eine gute UX liefern
        let resp = null;
        const text = await r.text();
        try { resp = text ? JSON.parse(text) : null; } catch { resp = { raw: text }; }

        if (!r.ok) {
          const msg = resp?.message || resp?.error || `HTTP ${r.status}`;
          showStatusMessage(`‚ùå <strong>Fehler beim Senden:</strong> ${escapeHtml(msg)}`);
          return;
        }

        // Credit verbuchen
        sendConsume('request_blogpost',
          { title, keywords: selectedKeywords, service, wordCount, tone },
          { response: resp }
        );

        const name = FIRST_NAME ? `, ${escapeHtml(FIRST_NAME)}` : '';
        showStatusMessage(
          `‚úÖ <strong>Alles klar${name}.</strong><br>` +
          `Wir haben deine Anfrage gespeichert. Du bekommst in etwa 15 Minuten eine E Mail an <strong>${escapeHtml(USER_EMAIL)}</strong> mit dem fertigen Blogpost.`
        );

      } catch (e) {
        showStatusMessage(`‚ùå <strong>Netzwerkfehler:</strong> ${escapeHtml(e.message || String(e))}<br><br>Wenn das im Browser passiert, ist es sehr oft CORS. Dann sende den Request √ºber eine Vercel API Route als Proxy oder aktiviere CORS f√ºr den n8n Webhook.`);
      } finally {
        hideTyping();
        if (btn) { btn.disabled = false; btn.innerHTML = 'üì© Blogpost anfordern, Ergebnis per E Mail'; }
      }
    };

    // =========================
    // Init
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      initKeywordTagSystem();
      updateKeywordCounter();

      // Hinweis falls Query Param fehlt
      if (!USER_EMAIL) {
        showStatusMessage('‚ö†Ô∏è Hinweis: Email wurde nicht √ºbergeben. In der Learningsuite Card muss userEmail korrekt gesetzt sein.');
      }

      setTimeout(() => {
        showStatusMessage(
          'üéØ <strong>Bereit.</strong><br>' +
          '1) Titel eintragen oder per Zauberstab optimieren. ' +
          '2) Keywords setzen. ' +
          '3) Dienstleistung eintragen. ' +
          '4) Absenden und Ergebnis per E Mail erhalten.'
        );
      }, 400);
    });
  </script>
</body>
</html>
